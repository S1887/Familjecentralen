import 'dotenv/config';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import googleCalendar from './googleCalendar.js';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Paths
const DATA_DIR = process.env.DATA_DIR || __dirname;
const LOCAL_EVENTS_FILE = path.join(DATA_DIR, 'local_events.json');
const IGNORED_EVENTS_FILE = path.join(DATA_DIR, 'ignored_events.json');

// Inbox source patterns to identify events that should be removed
const INBOX_SOURCES = [
    'HK LidkÃ¶ping',
    'HKL',
    'Handbollsskola',
    'RÃ¥da BK',
    'Villa LidkÃ¶ping',
    'Vklass',
    'Arsenal',
    'Ã–rgryte',
    'Ã–IS'
];

async function cleanupCalendar() {
    console.log('ğŸ§¹ Starting calendar cleanup...\n');

    // Step 1: Clear ignored events (restore "Ej aktuell")
    console.log('ğŸ“‹ Step 1: Restoring all "Ej aktuell" events...');
    if (fs.existsSync(IGNORED_EVENTS_FILE)) {
        const ignoredEvents = JSON.parse(fs.readFileSync(IGNORED_EVENTS_FILE, 'utf8'));
        console.log(`   Found ${ignoredEvents.length} ignored events`);

        // Clear the file
        fs.writeFileSync(IGNORED_EVENTS_FILE, JSON.stringify([], null, 2));
        console.log('   âœ… Cleared ignored_events.json\n');
    } else {
        console.log('   No ignored events file found\n');
    }

    // Step 2: Remove local events from inbox sources
    console.log('ğŸ“‹ Step 2: Removing local events from inbox sources...');
    if (fs.existsSync(LOCAL_EVENTS_FILE)) {
        const localEvents = JSON.parse(fs.readFileSync(LOCAL_EVENTS_FILE, 'utf8'));
        console.log(`   Found ${localEvents.length} local events`);

        const filteredEvents = localEvents.filter(event => {
            const source = event.source || event.originalSource || '';
            const isInboxSource = INBOX_SOURCES.some(pattern =>
                source.toLowerCase().includes(pattern.toLowerCase())
            );

            if (isInboxSource) {
                console.log(`   âŒ Removing: ${event.summary} (${source})`);
                return false;
            }
            return true;
        });

        console.log(`   Kept ${filteredEvents.length} events, removed ${localEvents.length - filteredEvents.length}`);
        fs.writeFileSync(LOCAL_EVENTS_FILE, JSON.stringify(filteredEvents, null, 2));
        console.log('   âœ… Updated local_events.json\n');
    } else {
        console.log('   No local events file found\n');
    }

    // Step 3: Remove events from Google Calendar (Family calendar)
    if (googleCalendar.isEnabled()) {
        console.log('ğŸ“‹ Step 3: Removing inbox-sourced events from Google Calendar...');

        try {
            const startTime = new Date();
            startTime.setMonth(startTime.getMonth() - 3);
            const endTime = new Date();
            endTime.setFullYear(endTime.getFullYear() + 1);

            // Fetch all events from Family calendar
            const events = await googleCalendar.listEvents(
                googleCalendar.CALENDAR_CONFIG.familjen,
                startTime.toISOString(),
                endTime.toISOString()
            );

            console.log(`   Found ${events.length} events in Family calendar`);

            let deletedCount = 0;
            for (const event of events) {
                const summary = event.summary || '';
                const source = event.extendedProperties?.private?.source || '';

                // Check if event came from inbox source
                const isInboxSource = INBOX_SOURCES.some(pattern =>
                    summary.toLowerCase().includes(pattern.toLowerCase()) ||
                    source.toLowerCase().includes(pattern.toLowerCase())
                );

                if (isInboxSource) {
                    console.log(`   ğŸ—‘ï¸  Deleting: ${summary}`);
                    try {
                        await googleCalendar.deleteEvent(
                            event.id,
                            googleCalendar.CALENDAR_CONFIG.familjen
                        );
                        deletedCount++;
                    } catch (err) {
                        console.error(`   âš ï¸  Failed to delete ${summary}: ${err.message}`);
                    }
                }
            }

            console.log(`   âœ… Deleted ${deletedCount} events from Google Calendar\n`);
        } catch (err) {
            console.error('   âŒ Failed to clean Google Calendar:', err.message, '\n');
        }
    } else {
        console.log('ğŸ“‹ Step 3: Google Calendar API not enabled, skipping\n');
    }

    console.log('âœ… Cleanup complete!\n');
    console.log('Summary:');
    console.log('  - Restored all "Ej aktuell" events');
    console.log('  - Removed local inbox-sourced events');
    console.log('  - Removed Google Calendar inbox-sourced events');
    console.log('\nRestart the server to see the clean calendar.');
}

cleanupCalendar().catch(err => {
    console.error('âŒ Cleanup failed:', err);
    process.exit(1);
});
